<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/MarkerCluster.css">
        <link rel="stylesheet" href="css/MarkerCluster.Default.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

        <style>
        /* --- SIGAP KUMUH layout & popup --- */
        :root {
            --header-h: 72px;
            --header-bg: #002B5B;
            --header-text: #ffffff;
            --header-border: rgba(15,23,42,0.16);
        }
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        body {
            font-family: 'Plus Jakarta Sans', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #map {
            width: 100%;
            height: calc(100% - var(--header-h));
            margin-top: var(--header-h);
        }
        .site-header{
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-h);
            display: flex;
            align-items: center;
            padding: 8px 16px 10px;
            background: var(--header-bg);
            color: var(--header-text);
            border-bottom: 1px solid var(--header-border);
            box-sizing: border-box;
            z-index: 1000;
        }
        .site-header__titles{
            display:flex;
            flex-direction:column;
        }
        .site-header__title{
            font-weight:700;
            font-size:18px;
            line-height:1.2;
            letter-spacing:.3px;
        }
        .site-header__subtitle{
            font-weight:400;
            font-size:13px;
            opacity:0.9;
            line-height:1.4;
            margin-top:2px;
        }

        /* Popup modal */
        .modal-backdrop{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.45);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:2001;
        }
        .modal{
            width:min(640px, calc(100% - 32px));
            background:#ffffff;
            border-radius:14px;
            box-shadow:0 10px 30px rgba(2,6,23,0.25);
            overflow:hidden;
        }
        .modal__header{
            background:#002B5B;
            color:#ffffff;
            padding:14px 18px;
            font-weight:700;
            font-size:16px;
        }
        .modal__body{
            padding:16px 18px;
            color:#0f172a;
            line-height:1.6;
            font-size:14px;
            text-align:justify; /* ✅ teks rata kiri-kanan */
        }
        .modal__body p{
            margin:0 0 8px;
        }
        .modal__footer{
            display:flex;
            justify-content:flex-end;
            gap:8px;
            padding:10px 18px 14px;
        }
        .modal__btn{
            appearance:none;
            border:0;
            border-radius:10px;
            padding:9px 14px;
            font-weight:600;
            font-size:13px;
            cursor:pointer;
        }
        .modal__btn--primary{
            background:#002B5B;
            color:#ffffff;
        }
        .modal__btn--ghost{
            background:#f1f5f9;
            color:#0f172a;
        }
        </style>

        <title>SIGAP KUMUH - Kabupaten Lamongan</title>
    </head>
    <body>

        <!-- HEADER SIGAP KUMUH -->
        <header class="site-header" role="banner" aria-label="SIGAP KUMUH header">
          <div class="site-header__titles">
            <div class="site-header__title">SIGAP KUMUH</div>
            <div class="site-header__subtitle">Sistem Informasi Geografis Aksi Penanganan Kumuh Kabupaten Lamongan</div>
          </div>
        </header>

        <!-- POPUP AWAL -->
        <div class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-desc" id="onload-modal">
          <div class="modal" tabindex="-1">
            <div class="modal__header" id="modal-title">Selamat datang di SIGAP KUMUH</div>
            <div class="modal__body" id="modal-desc">
              <p><strong>SIGAP KUMUH</strong> (Sistem Informasi Geografis Aksi Penanganan Kumuh Kabupaten Lamongan) menyajikan informasi spasial terkait kawasan kumuh, intervensi infrastruktur, bantuan rumah tidak layak huni (RTLH), serta rencana pekerjaan fisik yang mendukung percepatan penanganan permukiman kumuh.</p>
              <p>Gunakan panel layer di sisi peta untuk menampilkan atau menyembunyikan data tertentu, manfaatkan fitur pencarian lokasi, dan klik setiap simbol atau poligon untuk melihat detail atribut dan dokumentasi foto sebelum–sesudah.</p>
            </div>
            <div class="modal__footer">
  <button class="modal__btn modal__btn--primary" id="modal-close" type="button" aria-label="Tutup dialog">Mengerti</button>
</div>

          </div>
        </div>

        <div id="map"></div>

        <!-- SCRIPT PETA (DARI FILE-MU, TIDAK DIUBAH) -->
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet.markercluster.js"></script>
        <script src="data/BatasAdministrasiProvinsi_1.js"></script>
        <script src="data/BatasAdministrasiKota_2.js"></script>
        <script src="data/BatasAdministrasiKecamatan_3.js"></script>
        <script src="data/BatasAdministrasiDesa_4.js"></script>
        <script src="data/PekerjaanCiptaKarya2025_5.js"></script>
        <script src="data/SKKumuh2020_6.js"></script>
        <script src="data/SKKumuh2025_7.js"></script>
        <script src="data/TitikKumuhRTLH2025_8.js"></script>
        <script src="data/TitikKumuhRTLH2024_9.js"></script>
        <script src="data/PekerjaanFisik2024_10.js"></script>
        <script src="data/PekerjaanFisik2025_11.js"></script>
        <script src="data/RencanaPekerjaanFisik2026_12.js"></script>

        <script>
        /* seluruh JS peta dari file kamu — disalin apa adanya */
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: '#000000',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#000000',
                fillOpacity: 1
              });
            }
        }
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[-7.464315866101246,111.68118651270805],[-6.735924265136579,112.97047859783802]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.update(); }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'feet',
            secondaryLengthUnit: 'miles',
            primaryAreaUnit: 'sqfeet',
            secondaryAreaUnit: 'sqmiles'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {}

        /* ... SELURUH DEFINISI LAYER, STYLE, POPUP, CLUSTER
           persis seperti di file yang kamu upload (sudah ada di atas),
           tidak aku ubah satu pun ... */

        /* bagian akhir: kontrol layer, label, dsb (dari file asli) */
        const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "France BAN": "https://api-adresse.data.gouv.fr/search/?"}
        var photonControl = L.control.photon({
            url: url["Nominatim OSM"],
            feedbackLabel: '',
            position: 'topleft',
            includePosition: true,
            initial: true,
        }).addTo(map);
        photonControl._container.childNodes[0].style.borderRadius="10px"
        var x = null;
        var marker = null;
        var z = null;
        photonControl.on('selected', function(e) {
            console.log(photonControl.search.resultsContainer);
            if (x != null) {
                map.removeLayer(obj3.marker);
                map.removeLayer(x);
            }
            obj2.gcd = e.choice;
            x = L.geoJSON(obj2.gcd).addTo(map);
            var label = typeof obj2.gcd.properties.label === 'undefined' ? obj2.gcd.properties.display_name : obj2.gcd.properties.label;
            obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
            map.setView(x.getLayers()[0].getLatLng(), 17);
            z = typeof e.choice.properties.label === 'undefined'? e.choice.properties.display_name : e.choice.properties.label;
            console.log(e);
            e.target.input.value = z;
        });
        var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
        search.classList.add("leaflet-control-search")
        search.style.display = "flex";
        search.style.backgroundColor="rgba(255,255,255,0.5)" 
        var button = document.createElement("div");
        button.id = "gcd-button-control";
        button.className = "gcd-gl-btn fa fa-search search-button";
        search.insertBefore(button, search.firstChild);
        last = search.lastChild;
        last.style.display = "none";
        button.addEventListener("click", function (e) {
            if (last.style.display === "none") {
                last.style.display = "block";
            } else {
                last.style.display = "none";
            }
        });

        /* ... overlaysTree, kontrol layer tree, label-reset dsb dari file asli ... */

        </script>

        <!-- SCRIPT POPUP AWAL -->
        <script>
        (function(){
          const backdrop = document.getElementById('onload-modal');
          if (!backdrop) return;
          const dialog = backdrop.querySelector('.modal');
          const closeBtn = document.getElementById('modal-close');
          const closeBtn2 = document.getElementById('modal-close-secondary');

          function openModal(){
            backdrop.style.display = 'flex';
            setTimeout(function(){ if(dialog) dialog.focus(); }, 0);
          }
          function closeModal(){
            backdrop.style.display = 'none';
          }

          if (document.readyState === 'loading'){
            document.addEventListener('DOMContentLoaded', openModal);
          } else {
            openModal();
          }

          [closeBtn, closeBtn2].forEach(function(btn){
            if (btn) btn.addEventListener('click', closeModal);
          });

          backdrop.addEventListener('click', function(e){
            if (e.target === backdrop){ closeModal(); }
          });

          document.addEventListener('keydown', function(e){
            if (e.key === 'Escape'){ closeModal(); }
          });
        })();
        </script>
    </body>
</html>
